<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verification Code</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #fff;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .card-custom {
        width: 580px;
        max-width: 90%;
        padding: 5rem 3rem;
        border-radius: 1rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
      }
      .code-inputs input {
        width: 55px;
        height: 55px;
        text-align: center;
        font-size: 1.5rem;
      }
      .timer {
        color: #0f6546;
      }
      .btn-primary-custom {
        background-color: #0f6546;
        border: none;
        color: #fff; /* كلمة Continue بالابيض */
      }
      .btn-primary-custom:hover {
        background-color: #0c5038;
      }
      /* Resend أخضر مع خط تحته */
      .under-button-text a#resend-link {
        color: #0f6546 !important; /* اللون الأخضر */
        text-decoration: underline !important; /* الخط تحت الكلمة */
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="card card-custom">
      <h1 class="mb-3">Verification Code</h1>
      <p class="text-muted mb-4">
        Please enter the 4-digit verification code we sent to your email
        address.
      </p>

      <form id="verification-form" class="needs-validation" novalidate>
        <div class="d-flex justify-content-center mb-3 code-inputs">
          <input
            type="text"
            maxlength="1"
            pattern="[0-9]*"
            class="form-control mx-1"
            required
          />
          <input
            type="text"
            maxlength="1"
            pattern="[0-9]*"
            class="form-control mx-1"
            required
          />
          <input
            type="text"
            maxlength="1"
            pattern="[0-9]*"
            class="form-control mx-1"
            required
          />
          <input
            type="text"
            maxlength="1"
            pattern="[0-9]*"
            class="form-control mx-1"
            required
          />
        </div>
        <div class="timer text-center mb-3" id="timer-text">00:30</div>

        <button type="submit" class="btn btn-primary-custom w-100 mb-2">
          Continue
        </button>
      </form>

      <div class="under-button-text text-center">
        If you didn’t receive a code! <a id="resend-link">Resend</a>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  //  Initialize EmailJS
  (function () {
    emailjs.init("0XfsHu8x1pGBCOYJs"); // حط الـ Public key بتاعك هنا
  })();

  const inputs = document.querySelectorAll(".code-inputs input");
  inputs.forEach((input, index) => {
    input.addEventListener("input", () => {
      if (input.value.length === 1 && index < inputs.length - 1) {
        inputs[index + 1].focus();
      }
    });
    input.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !input.value && index > 0) {
        inputs[index - 1].focus();
      }
    });
  });

  // تايمر العد التنازلي
  let timeLeft = 30;
  const timerText = document.getElementById("timer-text");
  let resendDisabled = false;

  const timerInterval = setInterval(() => {
    if (timeLeft > 0) {
      timeLeft--;
      const seconds = timeLeft.toString().padStart(2, "0");
      timerText.textContent = `00:${seconds}`;
    } else {
      resendDisabled = false;
    }
  }, 1000);

  // الضغط على Resend
  document.getElementById("resend-link").addEventListener("click", () => {
    if (resendDisabled) return;

    const email = localStorage.getItem("email");
    if (!email) {
      alert(" No email found. Please go back and enter your email again.");
      return;
    }

    // Generate new OTP
    const newOtp = Math.floor(1000 + Math.random() * 9000);
    const params = {
      to_email: email,
      otp: newOtp,
    };

    // إرسال الكود من خلال EmailJS
    emailjs
      .send("service_m7hjqye", "template_vqfaygg", params)
      .then((res) => {
        alert(" Verification code resent successfully!");
        localStorage.setItem("otp", newOtp);
        timeLeft = 30;
        resendDisabled = true;
        timerText.textContent = "00:30";
      })
      .catch((err) => {
        console.error("EmailJS Error:", err);
        alert(" Failed to resend code. Check console for details.");
      });
  });

  // Bootstrap Validation + Redirect
  const form = document.getElementById("verification-form");
  form.addEventListener("submit", function (event) {
    event.preventDefault();

    const inputsOtp = document.querySelectorAll(".code-inputs input");
    const enteredOtp = Array.from(inputsOtp)
      .map((inp) => inp.value)
      .join(""); // جمع القيم

    const savedOtp = localStorage.getItem("otp");
    const savedEmail = localStorage.getItem("email");

    if (enteredOtp.length < inputsOtp.length) {
      alert(" Please enter all OTP digits");
      return;
    }

    if (enteredOtp.trim() !== savedOtp.trim()) {
      alert(" Incorrect OTP. Please try again");
      return;
    }

    alert(" OTP verified successfully for " + savedEmail);
    window.location.href = "New_password.html";
  });
</script>

  </body>
</html>
